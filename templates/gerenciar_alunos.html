{% extends "base.html" %}
{% block title %}Gerenciar Alunos{% endblock %}
{% block content %}
<div class="card">
    <h1>Gerenciamento de Alunos</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h2 style="font-weight: 400; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 30px;">Alunos Cadastrados</h2>
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Idade</th>
                <th>Curso</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for aluno in alunos %}
            <tr>
                <td>{{ aluno.nome }}</td>
                <td>{{ aluno.idade }}</td>
                <td>{{ aluno.curso | join(', ') }}</td>
                <td class="actions-cell">
                    {% if session.get('role') == 'admin' %}
                        <a href="{{ url_for('editar_aluno', nome_do_aluno=aluno.nome) }}" class="action-btn edit-btn">Editar</a>
                        <a href="{{ url_for('deletar_aluno', nome_do_aluno=aluno.nome) }}" class="action-btn delete-btn" onclick="return confirm('Tem certeza que deseja deletar este aluno e sua conta de login? Esta ação não pode ser desfeita.');">Deletar</a>
                    {% else %}
                        <span>Acesso restrito</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 style="font-weight: 400; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 50px;">Cadastrar Novo Aluno</h2>
    <form method="post" action="{{ url_for('gerenciar_alunos') }}" style="margin-top: 20px;">
        <div class="form-group">
            <label for="nome">Nome Completo (será o username):</label>
            <input type="text" id="nome" name="nome" required>
        </div>
        <div class="form-group">
            <label for="nascimento">Data de Nascimento:</label>
            <input type="date" id="nascimento" name="nascimento" required>
        </div>
        <div class="form-group">
            <label for="email">E-mail (opcional, para recuperação de senha):</label>
            <input type="email" id="email" name="email">
        </div>
        <div class="form-group" id="curso_field">
            <label class="form-label">Curso(s):</label>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" name="curso" value="Lógica de Programação"> Lógica de Programação
                </label>
                <label>
                    <input type="checkbox" name="curso" value="Linguagens de Programação"> Linguagens de Programação
                </label>
                <label>
                    <input type="checkbox" name="curso" value="Algorítimos e Estruturas de dados"> Algorítimos e Estruturas de dados
                </label>
            </div>
        </div>
        <div class="form-group">
            <label for="celular">Número de Celular:</label>
            <input type="tel" id="celular" name="celular" placeholder="(XX) XXXXX-XXXX">
        </div>
        <div class="form-group">
            <label for="cep">CEP:</label>
            <input type="text" id="cep" name="cep" required>
        </div>
        <div class="form-group">
            <label for="rua">Endereço (Rua):</label>
            <input type="text" id="rua" name="rua" readonly>
        </div>
        <div class="form-group">
            <label for="bairro">Bairro:</label>
            <input type="text" id="bairro" name="bairro" readonly>
        </div>
        <div class="form-group">
            <label for="cidade">Cidade:</label>
            <input type="text" id="cidade" name="cidade" readonly>
        </div>
        <div class="form-group">
            <label for="numero">Número:</label>
            <input type="text" id="numero" name="numero" required>
        </div>
        <div class="form-group">
            <label for="complemento">Complemento:</label>
            <input type="text" id="complemento" name="complemento">
        </div>
         <div class="form-group" id="horas_estudo_field">
            <label for="horas_estudo">Média de Horas de Estudo (por dia):</label>
            <input type="number" step="0.5" id="horas_estudo" name="horas_estudo" required min="0">
        </div>
        <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 10px 0;">
        <div id="login-fields" style="display: grid; gap: 20px;">
            <div class="form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group">
                <label for="role">Permissão (Função):</label>
                <select id="role" name="role" required onchange="handleRoleChange(this)">
                    <option value="aluno">Aluno</option>
                    <option value="professor">Professor</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
        </div>
        <button type="submit">Adicionar Aluno</button>
    </form>
</div>
<script>
    function handleRoleChange(selectElement) {
        const role = selectElement.value;
        const horasEstudoField = document.getElementById('horas_estudo_field');
        const cursoField = document.getElementById('curso_field');
        
        if (role === 'admin') {
            if (horasEstudoField) {
                horasEstudoField.style.display = 'none';
                horasEstudoField.querySelector('input').removeAttribute('required');
            }
            if (cursoField) {
                cursoField.style.display = 'none';
            }
        } else if (role === 'professor') {
            if (horasEstudoField) {
                horasEstudoField.style.display = 'none';
                horasEstudoField.querySelector('input').removeAttribute('required');
            }
            if (cursoField) {
                cursoField.style.display = 'block';
            }
        } else { // aluno
            if (horasEstudoField) {
                horasEstudoField.style.display = 'block';
                horasEstudoField.querySelector('input').required = true;
            }
            if (cursoField) {
                cursoField.style.display = 'block';
            }
        }
    }

    // Lógica para preenchimento automático do CEP
    document.getElementById('cep').addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('rua').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro;
                        document.getElementById('cidade').value = data.localidade;
                    } else {
                        alert('CEP não encontrado.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar o CEP:', error);
                    alert('Erro ao buscar o CEP. Tente novamente.');
                });
        }
    });
</script>
{% endblock %}